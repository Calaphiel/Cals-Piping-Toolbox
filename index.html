<!DOCTYPE html>
<html lang="en">
<head>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Pipefitterâ€™s Toolbox</title>
<style>
  :root{
    --bg:#1e1e1e; --fg:#eaeaea; --panel:#0f172a; --edge:#333;
    --muted:#94a3b8; --accent:#7dd3fc; --brand:#007bff; --brandH:#0056b3;
    --card:#0d1325;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Arial,Helvetica,sans-serif;overflow-x:hidden}
  header{background:#111;padding:18px;text-align:center;border-bottom:2px solid var(--edge)}
  h1{margin:0;font-size:22px}
  main{max-width:1000px;margin:0 auto;padding:18px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:600px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px;cursor:pointer;transition:transform .06s ease, border-color .2s}
  .card:hover{transform:translateY(-1px);border-color:#294476}
  .icon{font-size:22px;display:inline-block;width:28px}
  .title{font-size:16px;font-weight:700;margin-left:8px}
  .desc{color:var(--muted);font-size:13px;margin-top:8px;line-height:1.4}

  .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:14px;margin-bottom:16px}
  label{display:block;margin-top:10px;color:var(--muted);font-size:14px}
  input, select{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #444;background:#2b2b2b;color:#fff;box-sizing:border-box}
  button{width:100%;padding:12px;margin-top:14px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-size:16px;cursor:pointer}
  button:hover{background:var(--brandH)}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{border:1px solid #2f3b5c;padding:8px;text-align:center;font-size:14px}
  th{background:#132043}
  .results{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  @media(max-width:640px){.results{grid-template-columns:1fr}}
  .resbox{background:rgba(255,255,255,0.05);padding:12px;border-radius:8px}
  .label{font-size:13px;color:var(--muted)}
  .value{font-size:18px;color:var(--accent);margin-top:4px}
  .note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.4}
  .warn{color:#fb923c;font-size:14px;margin:8px 0}
  .topbar{display:flex;align-items:center;gap:10px;margin:8px 0 16px 0}
  .back{display:inline-block;padding:8px 10px;border-radius:8px;background:#24324f;color:#cfe6ff;border:1px solid #2b3b62;font-size:13px;cursor:pointer}
  .hidden{display:none}
  *{max-width:100%}
</style>
</head>
<body>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").then(()=>console.log("Service Worker registered"));
}
</script>

<header><h1>Pipefitterâ€™s Toolbox</h1></header>

<main>
<!-- HOMEPAGE -->
<section id="home">
  <div class="grid">
    <div class="card" data-open="tool-torque">
      <div><span class="icon">ğŸ”§</span><span class="title">Metric Bolt Torque</span></div>
      <div class="desc">M6â€“M36 | Dry, Lubed, Stainless | NÂ·m â†” ftÂ·lbf</div>
    </div>
    <div class="card" data-open="tool-arc">
      <div><span class="icon">ğŸ“</span><span class="title">Pipe Radius & Arc</span></div>
      <div class="desc">CLR, centre-to-face, one-elbow run & set</div>
    </div>
    <div class="card" data-open="tool-gaskets">
      <div><span class="icon">â­•</span><span class="title">PN Gasket Dimensions</span></div>
      <div class="desc">EN 1092-1 PN10 / PN16 / PN40 | DN15â€“DN600</div>
    </div>
    <div class="card" data-open="tool-lateral">
      <div><span class="icon">ğŸ”€</span><span class="title">Lateral Branch Cuts</span></div>
      <div class="desc">Header/branch ODs, angle, 16ths table</div>
    </div>
    <div class="card" data-open="tool-reference">
      <div><span class="icon">ğŸ“˜</span><span class="title">Reference Formulas</span></div>
      <div class="desc">Offsets, elbows, trig basics, pipe properties</div>
    </div>
    <div class="card" data-open="tool-rolling">
      <div><span class="icon">ğŸ”„</span><span class="title">Rolling Offset</span></div>
      <div class="desc">Travel, bend/cut angle, roll/twist, pup length</div>
    </div>
    <div class="card" data-open="tool-expansion">
      <div><span class="icon">ğŸŒ¡ï¸</span><span class="title">Thermal Expansion</span></div>
      <div class="desc">Î”L from length & dT, by material</div>
    </div>
    <div class="card" onclick="location.href='yaw.html'">
      <div><span class="icon">ğŸ§­</span><span class="title">Yaw Tool</span></div>
      <div class="desc">Relative yaw with zeroing (calibrated).</div>
    </div>
    <div class="card" onclick="location.href='right-triangle.html'">
      <div><span class="icon">â—£</span><span class="title">Right Triangle Solver</span></div>
      <div class="desc">Solve right triangles with 2 known values.</div>
    </div>
    <div class="card" data-open="tool-purge">
      <div><span class="icon">ğŸ’¨</span><span class="title">Purge Calculator</span></div>
      <div class="desc">Recommended L/min and initial purge time.</div>
    </div>
    <div class="card" onclick="location.href='elbow-penetration.html'">
      <span class="icon">ğŸ§±</span>
      <span class="title">Elbow Pass-Through</span>
      <div class="desc">Check if an LR elbow fits through a penetration.</div>
    </div>
  </div>
</section>

<!-- TORQUE -->
<section id="tool-torque" class="hidden">
  <div class="topbar"><span class="back" data-home>â† Back</span><h2>Metric Bolt Torque Chart</h2></div>
  <div class="panel">
    <label>Select Bolt Size</label>
    <select id="torque-boltSelect">
      <option value="">-- Choose --</option>
      <option>M6</option><option>M8</option><option>M10</option><option>M12</option>
      <option>M14</option><option>M16</option><option>M18</option><option>M20</option>
      <option>M22</option><option>M24</option><option>M27</option><option>M30</option>
      <option>M33</option><option>M36</option>
    </select>
    <button id="torque-unitToggle">Show in ftÂ·lbf</button>
    <div id="torque-result" class="value" style="margin-top:8px"></div>
  </div>
  <div class="panel">
    <h2>Reference Table â€” Recommended Torque</h2>
    <table>
      <thead>
        <tr><th>Bolt Size</th><th>Carbon Steel (Dry)</th><th>Carbon Steel (Lubed)</th><th>Stainless Steel</th></tr>
      </thead>
      <tbody id="torque-table"></tbody>
    </table>
  </div>
</section>

<!-- PIPE RADIUS & ARC (Elbow Takeoff: ONE ELBOW to FACE) -->
<section id="tool-arc" class="hidden">
  <div class="topbar"><span class="back" data-home>â† Back</span><h2>Elbow Takeoff</h2></div>
  <div class="panel">
    <label>Degree (Î¸) â€” one elbow</label>
    <input type="number" id="e_deg" placeholder="e.g. 45">

    <label>Nominal Bore (NB) â€” inches</label>
    <input type="number" id="e_nb" placeholder="e.g. 4">

    <label>Outside Diameter (OD) â€” mm</label>
    <input type="number" id="e_od" placeholder="e.g. 114.3">

    <div class="warn" id="e_warn"></div>

    <div class="results">
      <div class="resbox">
        <div class="label">Centre Line Radius (CLR)</div>
        <div class="value" id="e_clr">â€” mm</div>
        <div class="note">CLR = 1.5 Ã— NB (in) Ã— 25.4</div>
      </div>

      <div class="resbox">
        <div class="label">Centre To Face (CTF)</div>
        <div class="value" id="e_ctf">â€” mm</div>
        <div class="note">CTF = CLR Ã— tan(Î¸/2)</div>
      </div>

      <div class="resbox">
        <div class="label">Run (one elbow â†’ face)</div>
        <div class="value" id="e_run">â€” mm</div>
        <div class="note">Run = RÂ·sin(Î¸) + CTFÂ·cos(Î¸)</div>
      </div>

      <div class="resbox">
        <div class="label">Set (one elbow â†’ face)</div>
        <div class="value" id="e_set">â€” mm</div>
        <div class="note">Set = RÂ·(1 âˆ’ cos(Î¸)) + CTFÂ·sin(Î¸)</div>
      </div>

      <div class="resbox">
        <div class="label">Internal Radius</div>
        <div class="value" id="e_rInt">â€” mm</div>
        <div class="note">Rint = CLR âˆ’ OD/2</div>
      </div>

      <div class="resbox">
        <div class="label">External Radius</div>
        <div class="value" id="e_rExt">â€” mm</div>
        <div class="note">Rext = CLR + OD/2</div>
      </div>

      <div class="resbox">
        <div class="label">Internal Arc Length</div>
        <div class="value" id="e_lInt">â€” mm</div>
        <div class="note">Lint = Rint Ã— Ï€ Ã— Î¸/180</div>
      </div>

      <div class="resbox">
        <div class="label">External Arc Length</div>
        <div class="value" id="e_lExt">â€” mm</div>
        <div class="note">Lext = Rext Ã— Ï€ Ã— Î¸/180</div>
      </div>
    </div>
  </div>
</section>

<!-- GASKETS -->
<section id="tool-gaskets" class="hidden">
  <div class="topbar"><span class="back" data-home>â† Back</span><h2>PN Gasket Dimensions</h2></div>
  <div class="panel">
    <label>Select Pressure Rating</label>
    <select id="gsk-pnSelect">
      <option value="PN10" selected>PN10</option>
      <option value="PN16">PN16</option>
      <option value="PN40">PN40</option>
    </select>
  </div>
  <div class="panel">
    <h2 id="gsk-chartTitle">EN 1092-1 â€” PN10 Flat Ring Gaskets</h2>
    <table>
      <thead>
        <tr><th>DN</th><th>Nominal Bore (in)</th><th>Inside Ã˜ (mm)</th><th>Outside Ã˜ (mm)</th><th>Thickness (mm)</th></tr>
      </thead>
      <tbody id="gsk-table"></tbody>
    </table>
    <p class="note">Values are typical EN 1092-1 flat ring gasket dimensions. Confirm with supplier for critical service.</p>
  </div>
</section>

<!-- LATERAL / ANGLED BRANCH CUTS -->
<section id="tool-lateral" class="hidden">
  <div class="topbar">
    <span class="back" data-home>â† Back</span>
    <h2>Angled Branch Cuts (Branch up at Î¸Â° to Header)</h2>
  </div>

  <div class="panel">
    <label>Header OD (mm)</label>
    <input type="number" id="lat-headerOD" value="304.8">

    <label>Branch OD (mm)</label>
    <input type="number" id="lat-branchOD" value="254">

    <label>Branch ID (mm, optional)</label>
    <input type="number" id="lat-branchID" placeholder="Optional">

    <label>Branch angle to header (degrees)</label>
    <input type="number" id="lat-angle" value="60">
    <div class="note">
      Header vertical, branch also up but tilted at this angle to the header centre line.
    </div>

    <label>Number of Divisions</label>
    <input type="number" id="lat-divisions" value="16">

    <button id="lat-go">Calculate Cut Points</button>
  </div>

  <div class="panel" id="lat-results"></div>
</section>

<!-- REFERENCE -->
<section id="tool-reference" class="hidden">
  <div class="topbar"><span class="back" data-home>â† Back</span><h2>Reference Formulas</h2></div>
  <div class="panel">
    <h2>Basic Geometry</h2>
    <p><b>Circumference</b> = Ï€ Ã— Diameter</p>
    <p><b>Area of Circle</b> = Ï€ Ã— (RadiusÂ²)</p>
    <p><b>Pythagoras (Right Triangle)</b> = âˆš(AdjacentÂ² + OppositeÂ²) = Hypotenuse</p>
  </div>
  <div class="panel">
    <h2>Pipe Layout</h2>
    <p><b>Elbow Takeoff (LR)</b> = 1.5 Ã— NB (inches) Ã— 25.4</p>
    <p><b>Elbow Takeoff (SR)</b> = 1.0 Ã— NB (inches) Ã— 25.4</p>
    <p><b>Centre to Face</b> = tan(Angle Ã· 2) Ã— CLR</p>
    <p><b>Miter Cutback</b> = CLR Ã— tan(Angle Ã· 2)</p>
  </div>
  <div class="panel">
    <h2>Offsets</h2>
    <p><b>Simple Offset Travel</b> = âˆš(RunÂ² + SetÂ²)</p>
    <p><b>Rolling Offset Travel</b> = âˆš(RunÂ² + SetÂ² + RollÂ²)</p>
    <p><b>Bend Angle</b> = atan(Offset Ã· Run)</p>
    <p><b>Roll (Twist) Angle</b> = atan(Roll Ã· Set)</p>
    <p><b>Non-Parallel Offset Angle</b> = arccos(Roll Ã· Travel)</p>
  </div>
  <div class="panel">
    <h2>Pipe Properties</h2>
    <p><b>Weight per metre</b> = (Ï€/4) Ã— (ODÂ² âˆ’ IDÂ²) Ã— Density</p>
    <p><b>Internal Volume per metre</b> = (Ï€/4) Ã— (IDÂ²) Ã— 0.001 (litres)</p>
    <p><b>Surface Area (external)</b> = Ï€ Ã— OD Ã— Length</p>
    <p><b>Thermal Expansion</b> = Coefficient Ã— Length Ã— Î”T</p>
  </div>
  <div class="panel">
    <h2>Trigonometry Basics</h2>
    <p><b>sin(Î¸)</b> = Opposite Ã· Hypotenuse</p>
    <p><b>cos(Î¸)</b> = Adjacent Ã· Hypotenuse</p>
    <p><b>tan(Î¸)</b> = Opposite Ã· Adjacent</p>
    <p><b>Inverse:</b> Î¸ = sinâ»Â¹, cosâ»Â¹, tanâ»Â¹ of the ratio</p>
  </div>
</section>

<!-- ROLLING OFFSET -->
<section id="tool-rolling" class="hidden">
  <div class="topbar"><span class="back" data-home>â† Back</span><h2>Rolling Offset â€” Cut, Roll, Pup & Circumference</h2></div>
  <div class="panel">
    <label>Run length (mm)</label>
    <input type="number" id="roll-run" placeholder="e.g. 600">
    <label>Set length (mm)</label>
    <input type="number" id="roll-set" placeholder="e.g. 200">
    <label>Roll length (mm)</label>
    <input type="number" id="roll-roll" placeholder="e.g. 150">
    <label>Nominal Bore (NB) â€” inches (optional)</label>
    <input type="number" id="roll-nb" placeholder="e.g. 6">
    <label>Elbow type (for NB)</label>
    <select id="roll-type">
      <option value="LR" selected>Long Radius (1.5D)</option>
      <option value="SR">Short Radius (1.0D)</option>
    </select>
    <label>Pipe Outside Diameter (OD) â€” mm (optional)</label>
    <input type="number" id="roll-od" placeholder="e.g. 168.3">
    <div class="note">
      â€¢ Travel = âˆš(RunÂ² + SetÂ² + RollÂ²)<br>
      â€¢ Bend (cut) angle = atan( âˆš(SetÂ² + RollÂ²) Ã· Run ) â†’ degrees<br>
      â€¢ Roll (twist) angle = atan( Roll Ã· Set ) â†’ degrees<br>
      â€¢ Pup length requires NB + elbow type<br>
      â€¢ Circumference/mm per degree requires OD
    </div>
    <button id="roll-go">Calculate</button>
  </div>
  <div id="roll-results" class="panel hidden">
    <div class="results">
      <div class="resbox"><div class="label">Travel length</div><div class="value" id="roll-travel">â€”</div></div>
      <div class="resbox"><div class="label">Bend (cut) angle</div><div class="value" id="roll-bend">â€”</div></div>
      <div class="resbox"><div class="label">Roll (twist) angle</div><div class="value" id="roll-twist">â€”</div></div>
      <div class="resbox"><div class="label">Takeout per elbow</div><div class="value" id="roll-takeout">â€”</div></div>
      <div class="resbox"><div class="label">Pup length</div><div class="value" id="roll-pup">â€”</div></div>
      <div class="resbox"><div class="label">Circumference</div><div class="value" id="roll-circ">â€”</div></div>
      <div class="resbox"><div class="label">mm per degree</div><div class="value" id="roll-mmdeg">â€”</div></div>
    </div>
  </div>
</section>

<!-- THERMAL EXPANSION -->
<section id="tool-expansion" class="hidden">
  <div class="topbar"><span class="back" data-home>â† Back</span><h2>Pipe Thermal Expansion</h2></div>
  <div class="panel">
    <label>Pipe Length (m)</label>
    <input type="number" id="exp-length" placeholder="e.g. 30">
    <label>Temperature Change (Î”T Â°C)</label>
    <input type="number" id="exp-dt" placeholder="e.g. 80">
    <label>Material</label>
    <select id="exp-mat">
      <option value="0.012">Carbon Steel (0.012 mm/mÂ·Â°C)</option>
      <option value="0.017">Stainless Steel (0.017 mm/mÂ·Â°C)</option>
      <option value="0.017">Copper (0.017 mm/mÂ·Â°C)</option>
      <option value="0.060">PVC (0.060 mm/mÂ·Â°C)</option>
    </select>
    <button id="exp-go">Calculate Expansion</button>
  </div>
  <div id="exp-results" class="panel hidden">
    <div class="results">
      <div class="resbox"><div class="label">Expansion (Î”L)</div><div class="value" id="expansion-val">â€”</div></div>
    </div>
    <p class="note">Formula: Î”L = Î± Ã— L Ã— Î”T &nbsp; (Î± in mm/mÂ·Â°C; L in m â‡’ Î”L in mm)</p>
  </div>
</section>

<!-- PURGE CALCULATOR -->
<section id="tool-purge" class="hidden">
  <div class="topbar">
    <span class="back" data-home>â† Back</span>
    <h2>Purge Calculator</h2>
  </div>

  <div class="panel">
    <label>Pipe Internal Diameter (ID) â€” mm</label>
    <input type="number" id="purge-id" placeholder="e.g. 100">

    <label>Purge Length (between dams or ends) â€” mm</label>
    <input type="number" id="purge-length" placeholder="e.g. 1000">

    <label>Purge Quality</label>
    <select id="purge-quality">
      <option value="standard" selected>Standard (â‰ˆ4 volume changes)</option>
      <option value="critical">Critical (â‰ˆ6 volume changes)</option>
    </select>

    <div class="note">
      â€¢ Volume is based on ID and length between dams or flanges.<br>
      â€¢ Flow is what you set on the ball flowmeter (L/min).<br>
      â€¢ Time is the initial flush before striking arc.
    </div>

    <button id="purge-go">Calculate Purge</button>
  </div>

  <div id="purge-results" class="panel hidden">
    <div class="results">
      <div class="resbox">
        <div class="label">Pipe Volume</div>
        <div class="value" id="purge-vol">â€”</div>
        <div class="note">Internal volume of purge zone (L).</div>
      </div>

      <div class="resbox">
        <div class="label">Recommended Flow</div>
        <div class="value" id="purge-flow">â€”</div>
        <div class="note">Set your ball to this value (L/min).</div>
      </div>

      <div className="resbox">
        <div class="label">Initial Purge Time</div>
        <div class="value" id="purge-time">â€”</div>
        <div class="note">Time to flush before welding (min).</div>
      </div>

      <div class="resbox">
        <div class="label">Volumes Used</div>
        <div class="value" id="purge-vols">â€”</div>
        <div class="note">How many volume changes were assumed.</div>
      </div>
    </div>

    <p class="note">
      Flow rule-of-thumb: Flow â‰ˆ 0.06 Ã— ID(mm), clamped between 3â€“18 L/min.<br>
      Volume changes: 4 for standard work, 6 for critical purge quality.
    </p>
  </div>
</section>

</main>
<script>

const sections=[
  "home",
  "tool-torque",
  "tool-arc",
  "tool-gaskets",
  "tool-lateral",
  "tool-reference",
  "tool-rolling",
  "tool-expansion",
  "tool-purge"
];
/* ---------------- ROUTER ---------------- */
function show(id){
  sections.forEach(s=>document.getElementById(s)?.classList.add('hidden'));
  document.getElementById(id)?.classList.remove('hidden');
  window.scrollTo({top:0,behavior:'instant'});
}
document.querySelectorAll('[data-home]').forEach(b=>b.addEventListener('click',()=>show('home')));
document.querySelectorAll('#home .card').forEach(c=>c.addEventListener('click',()=>show(c.dataset.open)));

/* ---------------- TORQUE ---------------- */
const torqueData={
  "M6": {dry:10, lube:7, ss:6},
  "M8": {dry:25, lube:18, ss:16},
  "M10":{dry:49, lube:36, ss:32},
  "M12":{dry:85, lube:63, ss:56},
  "M14":{dry:135,lube:100,ss:90},
  "M16":{dry:210,lube:155,ss:140},
  "M18":{dry:290,lube:215,ss:195},
  "M20":{dry:410,lube:305,ss:275},
  "M22":{dry:550,lube:410,ss:370},
  "M24":{dry:710,lube:530,ss:480},
  "M27":{dry:1050,lube:785,ss:710},
  "M30":{dry:1450,lube:1080,ss:970},
  "M33":{dry:2000,lube:1500,ss:1350},
  "M36":{dry:2600,lube:1950,ss:1750}
};
let torqueUseFtLb=false;
function torqueToUnit(val){ return torqueUseFtLb ? (val*0.73756).toFixed(0)+" ftÂ·lbf" : val+" NÂ·m"; }
function torqueRenderTable(){
  const tbody=document.getElementById('torque-table');
  tbody.innerHTML="";
  for(const [size,vals] of Object.entries(torqueData)){
    tbody.innerHTML += `<tr>
      <td>${size}</td>
      <td>${torqueToUnit(vals.dry)}</td>
      <td>${torqueToUnit(vals.lube)}</td>
      <td>${torqueToUnit(vals.ss)}</td>
    </tr>`;
  }
}
torqueRenderTable();
document.getElementById('torque-unitToggle').addEventListener('click',()=>{
  torqueUseFtLb=!torqueUseFtLb;
  document.getElementById('torque-unitToggle').textContent = torqueUseFtLb ? "Show in NÂ·m" : "Show in ftÂ·lbf";
  torqueRenderTable();
  const sel=document.getElementById('torque-boltSelect');
  if(sel.value){
    const t=torqueData[sel.value];
    document.getElementById('torque-result').textContent =
      `${sel.value}: Carbon Steel (Dry) = ${torqueToUnit(t.dry)} | Carbon Steel (Lubed) = ${torqueToUnit(t.lube)} | Stainless Steel = ${torqueToUnit(t.ss)}`;
  }
});
document.getElementById('torque-boltSelect').addEventListener('change',e=>{
  const v=e.target.value, res=document.getElementById('torque-result');
  if(!v){res.textContent="";return;}
  const t=torqueData[v];
  res.textContent = `${v}: Carbon Steel (Dry) = ${torqueToUnit(t.dry)} | Carbon Steel (Lubed) = ${torqueToUnit(t.lube)} | Stainless Steel = ${torqueToUnit(t.ss)}`;
});

/* ---------------- ELBOW TAKEOFF (ONE ELBOW to FACE) ---------------- */
(function(){
  function fmt(v){ return Number(v).toFixed(2); }

  function calc(){
    const deg = parseFloat(document.getElementById('e_deg').value);
    const nb  = parseFloat(document.getElementById('e_nb').value);
    const od  = parseFloat(document.getElementById('e_od').value);
    const warn= document.getElementById('e_warn'); 
    warn.textContent='';

    // If NB is missing, clear outputs and bail
    if (!isFinite(nb)) { 
      ['e_clr','e_ctf','e_run','e_set','e_rInt','e_rExt','e_lInt','e_lExt']
        .forEach(id => document.getElementById(id).textContent = 'â€” mm');
      return; 
    }

    // CLR for LR elbow
    const R = 1.5 * nb * 25.4;
    document.getElementById('e_clr').textContent = fmt(R) + " mm";

    if (isFinite(deg)) {
      const th  = deg * Math.PI / 180;
      const CTF = R * Math.tan(th/2);         // centre-to-face
      document.getElementById('e_ctf').textContent = fmt(CTF) + " mm";

      // âœ… YOUR DEFINITION:
      // Single-elbow SET and RUN based ONLY on CTF
      const set1 = CTF * Math.cos(th);        // SET = CTF Â· cos(Î¸)
      const run1 = CTF + CTF * Math.sin(th);  // RUN = CTF + CTF Â· sin(Î¸)

      document.getElementById('e_set').textContent = fmt(set1) + " mm";
      document.getElementById('e_run').textContent = fmt(run1) + " mm";
    } else {
      document.getElementById('e_ctf').textContent = "â€” mm";
      document.getElementById('e_run').textContent = "â€” mm";
      document.getElementById('e_set').textContent = "â€” mm";
    }

    // Radii + arc lengths (unchanged)
    if (isFinite(od)) {
      const rInt = R - od/2;
      const rExt = R + od/2;
      document.getElementById('e_rInt').textContent = fmt(rInt) + " mm";
      document.getElementById('e_rExt').textContent = fmt(rExt) + " mm";
      if (rInt <= 0) warn.textContent = "âš  Internal radius â‰¤ 0 â€” OD too large for this NB.";

      if (isFinite(deg)) {
        const lInt = rInt * Math.PI * deg / 180;
        const lExt = rExt * Math.PI * deg / 180;
        document.getElementById('e_lInt').textContent = fmt(lInt) + " mm";
        document.getElementById('e_lExt').textContent = fmt(lExt) + " mm";
      } else {
        document.getElementById('e_lInt').textContent = "â€” mm";
        document.getElementById('e_lExt').textContent = "â€” mm";
      }
    } else {
      document.getElementById('e_rInt').textContent = "â€” mm";
      document.getElementById('e_rExt').textContent = "â€” mm";
      document.getElementById('e_lInt').textContent = "â€” mm";
      document.getElementById('e_lExt').textContent = "â€” mm";
    }
  }

  ['e_deg','e_nb','e_od'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('input', calc);
    el.addEventListener('change', calc);
  });
  calc();
})();

/* ---------------- GASKETS ---------------- */
const gasketData = {
  "PN10": {
    title: "EN 1092-1 â€” PN10 Flat Ring Gaskets",
    data: [
      {dn:"DN15", nb:'Â½"', id:18, od:58, thk:1.5},{dn:"DN20", nb:'Â¾"', id:25, od:65, thk:1.5},
      {dn:"DN25", nb:'1"', id:32, od:75, thk:1.5},{dn:"DN32", nb:'1Â¼"', id:38, od:90, thk:1.5},
      {dn:"DN40", nb:'1Â½"', id:45, od:100, thk:1.5},{dn:"DN50", nb:'2"', id:57, od:107, thk:1.5},
      {dn:"DN65", nb:'2Â½"', id:76, od:127, thk:1.5},{dn:"DN80", nb:'3"', id:89, od:142, thk:1.5},
      {dn:"DN100", nb:'4"', id:114, od:162, thk:1.5},{dn:"DN125", nb:'5"', id:140, od:192, thk:1.5},
      {dn:"DN150", nb:'6"', id:168, od:218, thk:1.5},{dn:"DN200", nb:'8"', id:219, od:273, thk:1.5},
      {dn:"DN250", nb:'10"', id:273, od:328, thk:1.5},{dn:"DN300", nb:'12"', id:324, od:378, thk:1.5},
      {dn:"DN350", nb:'14"', id:356, od:438, thk:1.5},{dn:"DN400", nb:'16"', id:406, od:489, thk:1.5},
      {dn:"DN450", nb:'18"', id:457, od:539, thk:1.5},{dn:"DN500", nb:'20"', id:508, od:594, thk:1.5},
      {dn:"DN600", nb:'24"', id:610, od:695, thk:1.5}
    ]
  },
  "PN16": {
    title: "EN 1092-1 â€” PN16 Flat Ring Gaskets",
    data: [
      {dn:"DN15", nb:'Â½"', id:18, od:62, thk:2},{dn:"DN20", nb:'Â¾"', id:25, od:68, thk:2},
      {dn:"DN25", nb:'1"', id:32, od:78, thk:2},{dn:"DN32", nb:'1Â¼"', id:38, od:94, thk:2},
      {dn:"DN40", nb:'1Â½"', id:45, od:104, thk:2},{dn:"DN50", nb:'2"', id:57, od:112, thk:2},
      {dn:"DN65", nb:'2Â½"', id:76, od:132, thk:2},{dn:"DN80", nb:'3"', id:89, od:148, thk:2},
      {dn:"DN100", nb:'4"', id:114, od:168, thk:2},{dn:"DN125", nb:'5"', id:140, od:198, thk:2},
      {dn:"DN150", nb:'6"', id:168, od:224, thk:2},{dn:"DN200", nb:'8"', id:219, od:279, thk:2},
      {dn:"DN250", nb:'10"', id:273, od:340, thk:2},{dn:"DN300", nb:'12"', id:324, od:395, thk:2},
      {dn:"DN350", nb:'14"', id:356, od:445, thk:2},{dn:"DN400", nb:'16"', id:406, od:505, thk:2},
      {dn:"DN450", nb:'18"', id:457, od:565, thk:2},{dn:"DN500", nb:'20"', id:508, od:620, thk:2},
      {dn:"DN600", nb:'24"', id:610, od:725, thk:2}
    ]
  },
  "PN40": {
    title: "EN 1092-1 â€” PN40 Flat Ring Gaskets",
    data: [
      {dn:"DN15", nb:'Â½"', id:18, od:68, thk:2},{dn:"DN20", nb:'Â¾"', id:25, od:75, thk:2},
      {dn:"DN25", nb:'1"', id:32, od:85, thk:2},{dn:"DN32", nb:'1Â¼"', id:38, od:100, thk:2},
      {dn:"DN40", nb:'1Â½"', id:45, od:110, thk:2},{dn:"DN50", nb:'2"', id:57, od:122, thk:2},
      {dn:"DN65", nb:'2Â½"', id:76, od:145, thk:2},{dn:"DN80", nb:'3"', id:89, od:154, thk:2},
      {dn:"DN100", nb:'4"', id:114, od:178, thk:2},{dn:"DN125", nb:'5"', id:140, od:210, thk:2},
      {dn:"DN150", nb:'6"', id:168, od:240, thk:2},{dn:"DN200", nb:'8"', id:219, od:295, thk:2},
      {dn:"DN250", nb:'10"', id:273, od:362, thk:2},{dn:"DN300", nb:'12"', id:324, od:422, thk:2},
      {dn:"DN350", nb:'14"', id:356, od:482, thk:2},{dn:"DN400", nb:'16"', id:406, od:542, thk:2},
      {dn:"DN450", nb:'18"', id:457, od:605, thk:2},{dn:"DN500", nb:'20"', id:508, od:665, thk:2},
      {dn:"DN600", nb:'24"', id:610, od:780, thk:2}
    ]
  }
};
function gskRender(pn){
  const t=gasketData[pn];
  document.getElementById('gsk-chartTitle').textContent=t.title;
  const body=document.getElementById('gsk-table');
  body.innerHTML="";
  t.data.forEach(r=>{
    body.innerHTML += `<tr><td>${r.dn}</td><td>${r.nb}</td><td>${r.id}</td><td>${r.od}</td><td>${r.thk}</td></tr>`;
  });
}
document.getElementById('gsk-pnSelect').addEventListener('change',e=>gskRender(e.target.value));
gskRender('PN10');

/* ---------------- LATERAL ---------------- */
document.getElementById('lat-go').addEventListener('click', ()=>{
  const H_OD = parseFloat(document.getElementById('lat-headerOD').value);
  const B_OD = parseFloat(document.getElementById('lat-branchOD').value);
  const B_ID = parseFloat(document.getElementById('lat-branchID').value);
  const angleDeg = parseFloat(document.getElementById('lat-angle').value);  // angle between axes
  const divisions = parseInt(document.getElementById('lat-divisions').value);

  // basic checks
  if ([H_OD, B_OD, angleDeg, divisions].some(v => !isFinite(v))) {
    alert("Please enter valid numbers for all required fields.");
    return;
  }

  // radii
  const H = H_OD / 2;
  const B = isFinite(B_ID) ? B_ID / 2 : B_OD / 2;
  if (B > H) {
    alert("Branch radius is larger than header radius! Check your inputs.");
    return;
  }

  // angle between branch and header axes (in radians)
  const angleRad = angleDeg * Math.PI / 180;
  const phiStep  = 360 / divisions;

  // branch circumference + mm per degree (for marking around branch)
  const circumference = Math.PI * B_OD;
  const mmPerDeg = circumference / 360;

  let html = `
    <div style="margin-bottom:10px;background:#0f172a;border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-around;flex-wrap:wrap;gap:8px;">
      <div>
        <span style="color:#94a3b8;font-size:13px;">Branch Circumference:</span><br>
        <span style="color:#7dd3fc;font-size:16px;">${circumference.toFixed(2)} mm</span>
      </div>
      <div>
        <span style="color:#94a3b8;font-size:13px;">mm per Degree (around branch):</span><br>
        <span style="color:#7dd3fc;font-size:16px;">${mmPerDeg.toFixed(3)} mm/Â°</span>
      </div>
      <div>
        <span style="color:#94a3b8;font-size:13px;">Branch angle to header:</span><br>
        <span style="color:#7dd3fc;font-size:16px;">${angleDeg.toFixed(2)}Â°</span>
      </div>
    </div>
  `;

  html += '<h3>Cut Table</h3><table><tr><th>Division</th><th>Phi (Â°)</th><th>Arc @ Phi (mm)</th><th>Cut Height (mm)</th></tr>';

  const rows = [];

  for (let i = 0; i <= divisions; i++) {
    // phi = angle around the branch circumference
    const phi = (i === divisions ? 360 : i * phiStep);
    const phiRad = phi * Math.PI / 180;

    // intersection geometry (angled branch to header)
    const sqrtArg = H*H - Math.pow(B * Math.sin(phiRad), 2);
    const arcMM   = circumference * (phi / 360);
    let cut = NaN;

    if (sqrtArg >= 0 && Math.sin(angleRad) !== 0 && Math.tan(angleRad) !== 0) {
      // same core formula, now clearly interpreted as ANGLE BETWEEN AXES
      const part1 = (H - Math.sqrt(sqrtArg)) / Math.sin(angleRad);
      const part2 = B * (1 - Math.cos(phiRad)) / Math.tan(angleRad);
      cut = part1 + part2;
    }

    rows.push({phi, arcMM, cut});
  }

  rows.forEach((r, idx) => {
    html += `<tr>
      <td>${idx === 0 ? 0 : idx}</td>
      <td>${r.phi.toFixed(2)}</td>
      <td>${r.arcMM.toFixed(2)}</td>
      <td>${isFinite(r.cut) ? r.cut.toFixed(2) : 'NaN'}</td>
    </tr>`;
  });

  html += '</table>';
  document.getElementById('lat-results').innerHTML = html;
});

/* ---------------- ROLLING OFFSET ---------------- */
function fmt2(n){return Number(n).toFixed(2);}
document.getElementById('roll-go').addEventListener('click', ()=>{
  const run=parseFloat(document.getElementById('roll-run').value);
  const set=parseFloat(document.getElementById('roll-set').value);
  const roll=parseFloat(document.getElementById('roll-roll').value);
  const nb=parseFloat(document.getElementById('roll-nb').value);
  const type=document.getElementById('roll-type').value;
  const od=parseFloat(document.getElementById('roll-od').value);
  if([run,set,roll].some(v=>!isFinite(v))){ alert("Please enter Run, Set and Roll."); return; }
  if(run<=0){ alert("Run must be > 0."); return; }
  const offset=Math.sqrt(set*set + roll*roll);
  const travel=Math.sqrt(run*run + offset*offset);
  const bendDeg=Math.atan2(offset, run)*180/Math.PI;
  const twistDeg=(set===0) ? (roll===0?0:90) : Math.atan2(roll,set)*180/Math.PI;
  let takeout=null, pup=null, circ=null, mmdeg=null;
  if(isFinite(nb)){
    const Rc=(type==='LR'?1.5:1.0)*nb*25.4;
    const bendRad=bendDeg*Math.PI/180;
    takeout=Rc*Math.tan(bendRad/2);
    pup=travel-2*takeout; if(pup<0) pup=0;
  }
  if(isFinite(od)){ circ=Math.PI*od; mmdeg=circ/360; }
  document.getElementById('roll-travel').textContent=fmt2(travel)+" mm";
  document.getElementById('roll-bend').textContent=fmt2(bendDeg)+"Â°";
  document.getElementById('roll-twist').textContent=fmt2(twistDeg)+"Â°";
  document.getElementById('roll-takeout').textContent=(takeout!==null?fmt2(takeout)+" mm":"â€”");
  document.getElementById('roll-pup').textContent=(pup!==null?fmt2(pup)+" mm":"â€”");
  document.getElementById('roll-circ').textContent=(circ!==null?fmt2(circ)+" mm":"â€”");
  document.getElementById('roll-mmdeg').textContent=(mmdeg!==null?fmt2(mmdeg)+" mm/Â°":"â€”");
  document.getElementById('roll-results').classList.remove('hidden');
});

/* ---------------- THERMAL EXPANSION ---------------- */
document.getElementById('exp-go').addEventListener('click', ()=>{
  const L=parseFloat(document.getElementById('exp-length').value);
  const dT=parseFloat(document.getElementById('exp-dt').value);
  const a=parseFloat(document.getElementById('exp-mat').value);
  if(!isFinite(L) || !isFinite(dT) || L<=0){ alert("Please enter valid values for length and Î”T."); return; }
  const dL=a*L*dT; // mm
  document.getElementById('expansion-val').textContent=Number(dL).toFixed(2)+" mm";
  document.getElementById('exp-results').classList.remove('hidden');
});

/* ---------------- PURGE CALCULATOR ---------------- */
(function(){
  function fmt(n, d=2){ return Number(n).toFixed(d); }

  document.getElementById('purge-go').addEventListener('click', ()=>{
    const idMM     = parseFloat(document.getElementById('purge-id').value);
    const lenMM    = parseFloat(document.getElementById('purge-length').value);
    const quality  = document.getElementById('purge-quality').value;

    if (!isFinite(idMM) || !isFinite(lenMM) || idMM <= 0 || lenMM <= 0) {
      alert("Please enter valid positive values for ID and length.");
      return;
    }

    // 1) Internal volume (L)
    // Volume_mm3 = Ï€ * (ID^2 / 4) * Length
    // 1 L = 1e6 mmÂ³ â†’ Volume_L = Volume_mm3 / 1e6
    const area_mm2   = Math.PI * idMM * idMM / 4;
    const vol_mm3    = area_mm2 * lenMM;
    const vol_L      = vol_mm3 / 1e6;

    // 2) Recommended flow (L/min)
    // Flow_raw â‰ˆ 0.06 Ã— ID(mm), clamped 3â€“18 L/min
    let flow_raw = 0.06 * idMM;
    let flow_Lmin = Math.max(3, Math.min(flow_raw, 18));

    // 3) Number of volume changes
    const N_vols = (quality === "critical") ? 6 : 4;

    // 4) Time (minutes)
    const time_min = (N_vols * vol_L) / flow_Lmin;

    // Update UI
    document.getElementById('purge-vol').textContent   = fmt(vol_L) + " L";
    document.getElementById('purge-flow').textContent  = fmt(flow_Lmin) + " L/min";
    document.getElementById('purge-time').textContent  = fmt(time_min,1) + " min";
    document.getElementById('purge-vols').textContent  = N_vols.toString() + " volumes";

    document.getElementById('purge-results').classList.remove('hidden');
  });
})();

</script>
</body>
</html>